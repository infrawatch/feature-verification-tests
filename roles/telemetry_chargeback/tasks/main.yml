---
- name: "Validate Chargeback Feature deployed correctly"
  ansible.builtin.include_tasks: "chargeback_tests.yml"

- name: "Setup Loki Environment"
  ansible.builtin.include_tasks: "setup_loki_env.yml"

- name: Get list of all OpenStack projects
  ansible.builtin.command:
    cmd: "{{ openstack_cmd }} project list -f json"
  register: openstack_project_list
  changed_when: false
  failed_when: false

- name: Parse project list from OpenStack CLI output
  block:
    - name: Set project list from JSON output
      ansible.builtin.set_fact:
        projects: "{{ (openstack_project_list.stdout | from_json) | default([]) }}"
      when: openstack_project_list.rc == 0 and (openstack_project_list.stdout | trim) != ""

    - name: Set empty project list when CLI failed or returned nothing
      ansible.builtin.set_fact:
        projects: []
      when: openstack_project_list.rc != 0 or (openstack_project_list.stdout | trim) == ""
  rescue:
    - name: Set empty project list on parse failure
      ansible.builtin.set_fact:
        projects: []

- name: "Display project names and IDs"
  ansible.builtin.debug:
    msg: "Project: {{ item.Name }} (ID: {{ item.ID }})"
  loop: "{{ projects }}"
  when: projects is defined and (projects | length) > 0

- name: Set admin project ID for CI
  ansible.builtin.set_fact:
    cloudkitty_project_id: "{{ (projects | selectattr('Name', 'equalto', 'admin') | list | map(attribute='ID') | first) | default('') }}"
  when: projects is defined

- name: "Find test files"
  ansible.builtin.find:
    paths: "{{ cloudkitty_scenario_dir }}"
    patterns: "test_*.yml"
  register: found_files_raw

- name: "Extract only the filenames into a clean list"
  ansible.builtin.set_fact:
    found_files: "{{ found_files_raw.files | map(attribute='path') | map('basename') | map('regex_replace', '\\.yml$', '') | list }}"

- name: "Run scenario file through workflow"
  block:
    - name: "Process and Loop if files exist"
      ansible.builtin.include_tasks: run_test_scenarios.yml
      loop: "{{ found_files }}"
      when: found_files | length > 0

    - name: Cleanup after job run
      ansible.builtin.include_tasks: cleanup_ck.yml

  rescue:
    - name: "Log failure"
      ansible.builtin.debug:
        msg: "Running test scenarios loop failed."
