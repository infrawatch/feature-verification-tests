---
- name: "Get OpenShift Console URL"
  ansible.builtin.shell:
    cmd: |
      oc get routes -n openshift-console -o jsonpath='{.items[0].spec.host}'
  register: console_url
  changed_when: false

- name: "Set OpenShift Console URL fact"
  ansible.builtin.set_fact:
    openshift_console_url: "https://{{ console_url.stdout }}"

- name: |
    Whoami oc
  ansible.builtin.shell:
    cmd: |
      oc whoami -c
  register: oc_login
  changed_when: false

- name: Show oc login output
  ansible.builtin.debug:
    var: oc_login.stdout_lines

- name: |
    Show kubeadmin-password
  ansible.builtin.shell:
    cmd: |
       cat {{ ansible_user_dir }}/.crc/machines/crc/kubeadmin-password
  register: kubeadmin
  changed_when: false

- name: Show oc users output
  ansible.builtin.debug:
    var: kubeadmin.stdout_lines

- name: |
    Crc credinteials
  ansible.builtin.shell:
    cmd: |
      crc console --credentials
  register: crc_crd
  changed_when: false

- name: Show oc login output
  ansible.builtin.debug:
    var: crc_crd.stdout_lines

- name: |
    Login with oc
  ansible.builtin.shell:
    cmd: |
       oc login -u kubeadmin -p 12345678 https://api.crc.testing:6443
  register: oc_login
  changed_when: false

- name: Show oc login output
  ansible.builtin.debug:
    var: oc_login.stdout_lines

- name: |
    TEST Check OpenShift Console is accessible
    RHOSO-13626
  ansible.builtin.shell:
    cmd: |
      curl -o /dev/null -s -w "%{http_code}" -k {{ openshift_console_url }}
  register: curl_result
  changed_when: false
  failed_when: curl_result.stdout != "200"
