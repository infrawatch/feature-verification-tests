---
- hosts: all
  name: "Create zuul-output log dir"
  gather_facts: false
  tasks:
    - name: "Create log dir"
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/zuul-output/logs"
        state: directory
        mode: "0755"

- hosts: controller
  name: "Run stf_functional_tests" 
  tasks:
    - name: "Set callback plugin"
      ansible.builtin.set_fact:
        ansible_stdout_callback: "callback_plugins.customer_logger"

    - name: "Run the stf_functional_tests playbook"
      ansible.builtin.include_tasks: stf_functional_tests.yml

    - name: "Copy generated logs"
      ansible.builtin.shell: |
        cp "/var/log/ansible/hosts/*" "{{ ansible_user_dir }}/zuul-output/logs"
      ignore_errors: true

