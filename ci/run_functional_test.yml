---
- name: Run telemetry tests on osp18
  hosts:  "{{ cifmw_target_hook_host | default('localhost')  }}"
  gather_facts: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars_files:
    - vars/common.yml
    - vars/osp18_env.yml
  tasks:
    - block:
        - name: "Run functional tests"
          ansible.builtin.import_role:
            name:  "{{ running_job }}"
          ignore_errors: true

      always:
        - name: Revert the version update
          ansible.builtin.shell:
            cmd: |
              oc patch  openstackversions controlplane  --type json -p='[{"op": "replace", "path": "/spec/customContainerImages", "value": {} }]'
          when: "{{ patch_openstackversions | bool }}"

        - name: Redeploy the dataplane
          ansible.builtin.shell:
            cmd: |
              oc get osdpd edpm-deployment -oyaml > /tmp/osdpd.yaml
              oc delete osdpd edpm-deployment
              sleep 10
              oc apply -f /tmp/osdpd.yaml
          when: "{{ patch_openstackversions | bool }}"


