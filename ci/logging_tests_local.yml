- name: Prepare Logging Tests
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    id_rsa_path:  "{{ playbook_dir }}/id_rsa.ctlplane"
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"

  tasks:
    - name: "Log into OCP"
      ansible.builtin.shell:
        cmd: |
          oc login -u kubeadmin -p "12345678" https://api.crc.testing:6443
      failed_when: false
      changed_when: false

    - name: "Create id rsa file for ctlplane access"
      ansible.builtin.shell:
        cmd: |
          oc extract -n openstack secrets/dataplane-ansible-ssh-private-key-secret --to=- | grep -v "ssh\-rsa" > "{{ id_rsa_path }}"
      register: rsa_results
      failed_when: rsa_results.rc != 0
      changed_when: false

    - name: Change files permissions
      ansible.builtin.shell:
        cmd: |
          chmod 600 "{{ id_rsa_path }}"
      changed_when: false  

- name: "RHOSO-12668"
# description: 'Verify logging projects exist'
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
     proj_out_file: verify_logging_projects_exist_lresults.log
     proj_list:
       - openshift-openstack-infra
       - openshift
       - openstack-operators
       - openshift-logging

  tasks:
    - name: Remove "{{ proj_out_file }}"
      ansible.builtin.file:
        path: "{{ proj_out_file }}"
        state: absent
      changed_when: false  

    - name: Verify projects created
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: proj_tests.yml
      loop: "{{ proj_list }}"


- name: "RHOSO-12682"
# description: Verify logging endpoints in OSP
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    endpoint_outfile: "verify_logging_endpoints_openstack_lresults.log"
    endpoints_list:
      - [nova,compute,public]
      - [nova,compute,internal]
      - [placement,placement,public]
      - [placement,placement,internal]
      - [swift,object-store,public]
      - [swift,object-store,internal]
      - [cinderv3,volumev3,public]
      - [cinderv3,volumev3,internal]
      - [barbican,key-manager,public]
      - [barbican,key-manager,internal]
      - [keystone,identity,public]
      - [keystone,identity,internal]
      - [glance,image,public]
      - [glance,image,internal]
      - [neutron,network,public]
      - [neutron,network,internal]

  tasks:
    - name: Remove "{{ endpoint_outfile }}"
      ansible.builtin.file:
        path: "{{ endpoint_outfile }}"
        state: absent
      changed_when: false

    - name: Verfiy Endpoints
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: endpoint_tests.yml
      loop: "{{ endpoints_list }}"


- name: "RHOSO-12670"
# description: Verify logging credentials exist
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    cred_out_file: verify_logging_credentials_exist_lresults.log
    cred_list:
      - alertingrules.loki.grafana.com
      - lokistacks.loki.grafana.com
      - recordingrules.loki.grafana.com
      - rulerconfigs.loki.grafana.com

  tasks:
    - name: Remove "{{ cred_out_file }}"
      ansible.builtin.file:
        path: "{{ cred_out_file }}"
        state: absent
      changed_when: false

    - name: Verify credentials created
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: cred_tests.yml
      loop: "{{ cred_list }}"


- name: "RHOSO-12671"
# description: Verify logging OSP nodes are running
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    node_out_file: verify_logging_osp_nodes_running_lresults.log
    node_list:
      - edpm-compute-0
      - edpm-compute-1
      - crc

  tasks:
    - name: Remove "{{ node_out_file }}"
      ansible.builtin.file:
        path: "{{ node_out_file }}"
        state: absent
      changed_when: false

    - name: Verify nodes deployed
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: node_tests.yml
      loop: "{{ node_list }}"


- name: "RHOS0-12672"
# description: Verify logging pods are running in openstack-operator
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    pod_status_str: "Running"      
    nspace: openstack-operators
    pod_out_file: verify_logging_pods_running_openstack-operator_lresults.log
    pod_list:
      - telemetry-operator-controller-manager
      - dataplane-operator-controller-manager

  tasks:
    - name: Remove "{{ pod_out_file }}"
      ansible.builtin.file:
        path: "{{ pod_out_file }}"
        state: absent
      changed_when: false

    - name: Verify Running Pods
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: pod_tests.yml
      loop: "{{ pod_list }}"


- name: "RHOSO-12752"
# description: Verify logging pods are running in openstack
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    pod_status_str: "Running"
    nspace: openstack
    pod_out_file: verify_logging_pods_running_openstack_lresults.log
    pod_list:
      - openstackclient

  tasks:
    - name: Remove "{{ pod_out_file }}"
      ansible.builtin.file:
        path: "{{ pod_out_file }}"
        state: absent
      changed_when: false

    - name: Verify Running Pods
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: pod_tests.yml
      loop: "{{ pod_list }}"


- name: "RHOSO-12673"
# description: Verify logging pods are running in openshift-operators-redhat
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    pod_status_str: "Running"
    nspace: openshift-operators-redhat
    pod_out_file: verify_logging_pods_running_openshift-operators-redhat_lresults.log
    pod_list:
      - loki-operator-controller-manager

  tasks:
    - name: Remove "{{ pod_out_file }}"
      ansible.builtin.file:
        path: "{{ pod_out_file }}"
        state: absent
      changed_when: false

    - name: Verify Pods running
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: pod_tests.yml
      loop: "{{ pod_list }}"


- name: "RHOSO-12676"
# description: Verify logging pods are running in openshift-logging
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    pod_status_str: "Running"
    nspace: openshift-logging
    pod_out_file: verify_logging_pods_running_openshift-logging_lresults.log
    pod_list:
      - cluster-logging-operator
      - collector
      - logging-loki-compactor
      - logging-loki-distributor
      - logging-loki-gateway
      - logging-loki-index-gateway
      - logging-loki-ingester
      - logging-loki-querier
      - logging-loki-query-frontend
      - logging-view-plugin

  ### see JIRA LOG-5431 if pods not running
  tasks:
    - name: Remove "{{ pod_out_file }}"
      ansible.builtin.file:
        path: "{{ pod_out_file }}"
        state: absent
      changed_when: false

    - name: Verify Pods running
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: pod_tests.yml
      loop: "{{ pod_list }}"


- name: "RHOSO-12674"
# description: Verify logging pods are running in minio-dev
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    pod_status_str: "Running"
    nspace: minio-dev
    pod_out_file: verify_minio-dev_pods_running_lresults.log
    pod_list:
      - minio

  tasks:
    - name: Remove "{{ pod_out_file }}"
      ansible.builtin.file:
        path: "{{ pod_out_file }}"
        state: absent
      changed_when: false

    - name: Verify running pods
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: pod_tests.yml
      loop: "{{ pod_list }}"


- name: "RHOSO-12679"
# description: Verify logging pods have complete status in openstack 
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    pod_out_file: verify_logging_pods_completed_in_openstack_lresults.log
    nspace: openstack
    pod_status_str: "Completed"
    pod_list:
      - bootstrap-edpm-deployment-logging
      - configure-network-edpm-deployment-logging
      - configure-os-edpm-deployment-logging
      - download-cache-edpm-deployment-logging
      - install-certs-edpm-deployment-logging
      - install-os-edpm-deployment-logging
      - libvirt-edpm-deployment-logging
      - logging-edpm-deployment-logging-openstack-edpm
      - neutron-metadata-edpm-deployment-logging
      - nova-custom-edpm-deployment
      - ovn-edpm-deployment-logging
      - reboot-os-edpm-deployment-logging
      - repo-setup-edpm-deployment-logging
      - run-os-edpm-deployment-logging
      - ssh-known-hosts-edpm-deployment-logging
      - telemetry-edpm-deployment-logging
      - validate-network-edpm-deployment-logging

  tasks:
    - name: Remove "{{ pod_out_file }}"
      ansible.builtin.file:
        path: "{{ pod_out_file }}"
        state: absent
      changed_when: false

    - name: Verify pods completed
      ansible.builtin.include_role:
        name: qe_common        
        tasks_from: pod_tests.yml
      loop: "{{ pod_list }}"


- name: "RHOSO-12675"
# description: Verify logging services are running in openshift-logging
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    services_out_file: verify_logging_services_running_in_openshift-logging_lresults.log
    nspace: openshift-logging
    services_list:
      - cluster-logging-operator-metrics
      - logging-loki-compactor-grpc
      - logging-loki-compactor-http
      - logging-loki-distributor-grpc
      - logging-loki-distributor-http
      - logging-loki-gateway-http
      - logging-loki-gossip-ring
      - logging-loki-index-gateway-grpc
      - logging-loki-index-gateway-http
      - logging-loki-ingester-grpc
      - logging-loki-ingester-http
      - logging-loki-querier-grpc
      - logging-loki-querier-http
      - logging-loki-query-frontend-grpc
      - logging-loki-query-frontend-http
      - logging-view-plugin
      - openstack-logging

  tasks:
    - name: Remove "{{ services_out_file }}"
      ansible.builtin.file:
        path: "{{ services_out_file }}"
        state: absent
      changed_when: false

    - name: Run Services Test in "{{ nspace }}"
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: services_tests.yml
      loop: "{{ services_list }}"


- name: "RHOSO-12749"
# description: Verify logging services are running in openstack
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    services_out_file: verify_openstack_services_running_lresults.log
    nspace: openstack
    services_list:
      - nova-internal
      - nova-metadata-internal
      - nova-novncproxy-cell1-public
      - nova-public

  tasks:
    - name: Remove "{{ services_out_file }}"
      ansible.builtin.file:
        path: "{{ services_out_file }}"
        state: absent
      changed_when: false 

    - name: Run Services test in "{{ nspace }}" 
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: services_tests.yml
      loop: "{{ services_list }}"


- name: "RHOSO-12677"
# description: Verify logging packagemanifest exist
  hosts: localhost 
  connection: local
  gather_facts: no
  vars:
    manifest_out_file: verify_packagemanifests_exist_lresults.log
    packagemanifests_list:
      - "loki-operator 2"
      - "loki-helm-operator 1"

  tasks:
    - name: Remove "{{ manifest_out_file }}"
      ansible.builtin.file:
        path: "{{ manifest_out_file }}"
        state: absent
      changed_when: false

    - name: Run packagemanifest tests
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: manifest_tests.yml
      loop: "{{ packagemanifests_list }}"


- name: "RHOSO-12678"
# description: Verify logging subscriptions exist in openshift-operators-redhat
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    nspace: openshift-operators-redhat 
    subscript_out_file: verify_openshift-operators-redhat_subscriptions_lresults.log 
    subscription_list:
      - loki-operator

  tasks:
    - name: Remove "{{ subscript_out_file }}"
      ansible.builtin.file:
        path: "{{ subscript_out_file }}"
        state: absent
      changed_when: false

    - name: Run subscription tests
      ansible.builtin.include_role:
        name: qe_common
        tasks_from: subscription_tests.yml
      loop: "{{ subscription_list }}"
