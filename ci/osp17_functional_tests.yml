---
- name: "Run functional test playbooks"
  hosts:  controller
  gather_facts: false
  vars:
    rdo_dir: "{{ ansible_env.HOME }}/{{ zuul.projects['github.com/rdo-infra/rdo-jobs'].src_dir }}/playbooks/data_plane_adoption"
    framework_dir: "{{ ansible_env.HOME }}/{{ zuul.projects['github.com/openstack-k8s-operators/ci-framework'].src_dir }}"
    install_yaml_dir: "{{ ansible_env.HOME }}/{{ zuul.projects['github.com/openstack-k8s-operators/install_yamls'].src_dir }}"
    fvt_dir: "{{ ansible_env.HOME }}/{{ zuul.projects['github.com/infrawatch/feature-verification-tests'].src_dir }}"
  tasks: 
    - name: Setup the env before running the autoscaling functional test
    block:
      - name: Create inventory to run tasks inside vm
        ansible.builtin.template:
          src: "{{ rdo_dir }}/files/standalone_vm_inventory.yaml.j2"
          dest: "/home/zuul/{{ standalone_vm_inventory | default('standalone_vm_inventory') }}"

      - name: Install collections to use nmcli and libvirt ansible modules
        ansible.builtin.command: ansible-galaxy collection install community.general community.libvirt
      
      - name: Write out the repo setup commands to file for standalone to use
        ansible.builtin.copy:
          dest: /home/zuul/cdn_subscription_repos.sh
          content: |
            subscription-manager repos --enable openstack-17.1-for-rhel-9-x86_64-rpms
            subscription-manager repos --enable rhceph-6-tools-for-rhel-9-x86_64-rpms
            subscription-manager repos --enable fast-datapath-for-rhel-9-x86_64-rpms
            subscription-manager repos --enable rhel-9-for-x86_64-highavailability-eus-rpms

      - name: Deploy the standalone with ci_framework_deploy_standalone_vm.yaml
        ansible.builtin.shell: >
          ansible-playbook {{ rdo_jobs_dir }}/ci_framework_deploy_standalone_vm.yaml -e "job_name={{ zuul.job }}"
          {% if dpa_standalone_ntp_server is defined %}
          -e ntp_override={{ dpa_standalone_ntp_server }}
          {% endif %}
          -e repo_setup_commands=/home/zuul/cdn_subscription_repos.sh
          -e "standalone_ip={{ standalone_ip }}" -e "standalone_gateway={{ standalone_gateway }}"
          -e "standalone_dns={{ standalone_dns | default(standalone_gateway) }}"
          -e "use_ceph={{ use_ceph | default('true') }}"
          -e "cloud_domain={{ cloud_domain | default('localdomain') }}"
          -e "enable_tls={{ enable_tls | default('false') }}"
        args:
          chdir: "{{ framework_dir }}"

      - name: Wait for standalone vm to be available
        ansible.builtin.wait_for:
          port: 22
          host: "{{ standalone_ip }}"
          delay: 10
          timeout: 300
        vars:
          ansible_user: root
          ansible_ssh_private_key_file: "{{ install_yaml_dir }}/out/edpm/ansibleee-ssh-key-id_rsa"

      - name: Accept standalone vm ssh host keys to avoid prompt connecting for the first time
        connection: local
        ansible.builtin.shell: |
          ssh-keygen -F {{ standalone_ip }} ||
          ssh-keyscan -H {{ standalone_ip }} >> ~/.ssh/known_hosts
        register: known_hosts_script
        changed_when: "'found' not in known_hosts_script.stdout"


      - name: Run test preparation in standalone vm
        ansible.builtin.shell:
          ansible-playbook ci/run_tests_ops17.yml -i /home/zuul/{{ standalone_vm_inventory | default("standalone_vm_inventory") }}
        chdir: "{{ fvt_dir }}"
