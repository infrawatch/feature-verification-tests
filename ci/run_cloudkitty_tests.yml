---
- name: Run pre-test steps
  ansible.builtin.import_playbook: pre-test-steps.yml

- name: Run cloudkitty tests on osp18
  hosts:  "{{ cifmw_target_hook_host | default('localhost')  }}"
  gather_facts: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars_files:
    - vars/common.yml
    - vars/osp18_env.yml
  tasks:
    - block:
        #- name: Include vars from the extra_vars files
        #    ansible.builtin.include_vars:
        #      dir: "{{ cifmw_basedir }}/artifacts/parameters"

        - name: Patch cloudkittyclient into openstackclient
          ansible.builtin.shell:
            cmd: |
              oc exec -n openstack openstackclient -- python3 -m ensurepip --upgrade
              oc exec -n openstack openstackclient -- python3 -m pip install --upgrade git+https://github.com/openstack/python-cloudkittyclient@master

        - name: Check that the API is available
          ansible.builtin.shell:
            cmd: |
              {{ openstack_cmd }} rating module list
