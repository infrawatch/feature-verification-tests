---
- name: "Verify logging projects, endpoints, credentials, nodes, pods, services, manifests and subscriptions"
  hosts: controller
  gather_facts: no
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars_files:
    - vars/osp18_env.yml
  vars:
    common_pod_test_id: "RHOSO-12672"
    # common_pod_status_str: "Running"
    # common_pod_nspace: openstack-operators
    common_pod_list:
      - { name: telemetry-operator-controller-manager, nspace: openstack-operators, status_str: "Running", test_id: "RHOSO-13761" }
      - { name: openstack-operator-controller-manager, nspace: openstack-operators, status_str: "Running", test_id: "RHOSO-13762" }
    common_subscription_test_id: "RHOSO-12678"
    # common_subscription_nspace: openshift-operators-redhat
    common_subscription_list:
      - { name: loki-operator, nspace: openshift-operators-redhat, test_id: "RHOSO-12678"}
    #common_project_test_id: "RHOSO-12668"
    common_project_list:
      - { name: openshift-openstack-infra, test_id: "RHOSO-13764" }
      - { name: openshift, test_id: "RHOSO-13763"}
      - { name: openstack-operators, test_id: "RHOSO-13732" }
      - { name: openshift-logging, test_id: "RHOSO-13731"}
    common_endpoint_test_id: "RHOSO-12682"
    common_endpoint_list:
      - [nova,compute,public]
      - [nova,compute,internal]
      - [placement,placement,public]
      - [placement,placement,internal]
      - [swift,object-store,public]
      - [swift,object-store,internal]
      - [cinderv3,volumev3,public]
      - [cinderv3,volumev3,internal]
      - [barbican,key-manager,public]
      - [barbican,key-manager,internal]
      - [keystone,identity,public]
      - [keystone,identity,internal]
      - [glance,image,public]
      - [glance,image,internal]
      - [neutron,network,public]
      - [neutron,network,internal]
    common_manifest_test_id: "RHOSO-12677"
    common_manifest_list:
      - ["loki-operator", "2"]
      - ["loki-helm-operator", "1"]
    common_service_test_id: "RHOSO-12675"
    # common_service_nspace: openshift-logging
    common_service_list:
      - { name: cluster-logging-operator-metrics, nspace: openshift-logging,test_id: "RHOSO-13744"}
      - { name: logging-loki-compactor-grpc, nspace: openshift-logging, test_id: "RHOSO-13746"}
      - { name: logging-loki-compactor-http, nspace: openshift-logging, test_id: "RHOSO-13747"}
      - { name: logging-loki-distributor-grpc, nspace: openshift-logging, test_id: "RHOSO-13748"}
      - { name: logging-loki-distributor-http, nspace: openshift-logging, test_id: "RHOSO-13749"}
      - { name: logging-loki-gateway-http, nspace: openshift-logging, test_id: "RHOSO-13750"}
      - { name: logging-loki-gossip-ring, nspace: openshift-logging, test_id: "RHOSO-13751"}
      - { name: logging-loki-index-gateway-grpc, nspace: openshift-logging, test_id: "RHOSO-13752"}
      - { name: logging-loki-index-gateway-http, nspace: openshift-logging, test_id: "RHOSO-13753"}
      - { name: logging-loki-ingester-grpc, nspace: openshift-logging, test_id: "RHOSO-13754"}
      - { name: logging-loki-ingester-http, nspace: openshift-logging, test_id: "RHOSO-13755"}
      - { name: logging-loki-querier-grpc, nspace: openshift-logging, test_id: "RHOSO-13756"}
      - { name: logging-loki-querier-http, nspace: openshift-logging, test_id: "RHOSO-13757"}
      - { name: logging-loki-query-frontend-grpc, nspace: openshift-logging, test_id: "RHOSO-13758"}
      - { name: logging-loki-query-frontend-http, nspace: openshift-logging, test_id: "RHOSO-13759"}
      - { name: openstack-logging, nspace: openshift-logging, test_id: "RHOSO-13760"}
  tasks:
    - name: "Verify logging infrastructure components"
      ansible.builtin.import_role:
        name: common

- name: "Verify logging pods are running in openstack"
  hosts: controller
  gather_facts: no
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars:
    common_pod_test_id: "RHOSO-12752"
    # common_pod_status_str: "Running"
    # common_pod_nspace: openstack
    common_pod_list:
      - { name: openstackclient, status_str: "Running", nspace: "openstack", test_id: "RHOSO-12752"}
  tasks:
    - name: "Verify Running Pods"
      ansible.builtin.import_role:
        name: common


- name: "Verify logging pods are running in openshift-operators-redhat"
  hosts: controller
  gather_facts: no
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars:
    common_pod_test_id: "RHOSO-12673"
    #common_pod_status_str: "Running"
    #common_pod_nspace: openshift-operators-redhat
    common_pod_list:
      - { name: loki-operator-controller-manager, nspace: openshift-operators-redhat, status_str: "Running", test_id: "RHOSO-12673"}
  tasks:
    - name: "Verify Pods running"
      ansible.builtin.import_role:
        name: common

- name: "Verify logging pods are running in openshift-logging"
  hosts: controller
  gather_facts: no
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars:
    common_pod_test_id: "RHOSO-12676"
    # common_pod_status_str: "Running"
    # common_pod_nspace: openshift-logging
    common_pod_list:
      - { name: cluster-logging-operator, nspace: openshift-logging, status_str: "Running", test_id: "{{ common_pod_test_id }}" }
      - { name: logging-loki-compactor, nspace: openshift-logging, status_str: "Running", test_id: "RHOSO-13778" }
      - { name: logging-loki-distributor, nspace: openshift-logging, status_str: "Running", test_id: "RHOSO-13780" }
      #- { name: logging-loki-gateway, nspace: openshift-logging, status_str: "Running", test_id: "{{ common_pod_test_id }}" }
      - { name: logging-loki-index-gateway, nspace: openshift-logging, status_str: "Running", test_id: "RHOSO-13781" }
      - { name: logging-loki-ingester, nspace: openshift-logging, status_str: "Running", test_id: "RHOSO-13782" }
      - { name: logging-loki-querier, nspace: openshift-logging, status_str: "Running", test_id: "RHOSO-13783" }
      - { name: logging-loki-query-frontend, nspace: openshift-logging, status_str: "Running", test_id: "RHOSO-13784" }
      - { name: collector, nspace: openshift-logging, status_str: "Running", test_id: "RHOSO-13745"}


  ### see JIRA LOG-5431 if pods not running
  tasks:
    - name: "Verify Pods running"
      ansible.builtin.import_role:
        name: common

- name: "Verify logging pods are running in minio-dev"
  hosts: controller
  gather_facts: no
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars:
    common_pod_test_id: "RHOSO-12674"
    # common_pod_status_str: "Running"
    # common_pod_nspace: minio-dev
    common_pod_list:
      - { name: minio, nspace: minio-dev, status_str: "Running", test_id: "RHOSO-12674" }
  tasks:
    - name: "Run pod running tests"
      ansible.builtin.import_role:
        name: common


- name: "Verify logging pods have complete status in openstack"
  hosts: controller
  gather_facts: no
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars:
    #common_pod_test_id: "RHOSO-12679"
    #common_pod_nspace: openstack
    #common_pod_status_str: "Completed"
    common_pod_list:
      # - bootstrap-edpm-deployment-openstack-edpm-ipam
      # - configure-network-edpm-deployment-openstack-edpm-ipam
      # - configure-os-edpm-deployment-openstack-edpm-ipam
      # - download-cache-edpm-deployment-openstack-edpm-ipam
      # - install-certs-edpm-deployment-openstack-edpm-ipam
      # - install-os-edpm-deployment-openstack-edpm-ipam
      # - libvirt-edpm-deployment-openstack-edpm-ipam
      # - logging-edpm-deployment-openstack-edpm-ipam
      # - neutron-metadata-edpm-deployment-openstack-edpm-ipam
      # - nova-edpm-deployment-openstack-edpm-ipam
      # - ovn-edpm-deployment-openstack-edpm-ipam
      # - reboot-os-edpm-deployment-openstack-edpm-ipam
      # - run-os-edpm-deployment-openstack-edpm-ipam
      # - ssh-known-hosts-edpm-deployment
      # - telemetry-edpm-deployment-openstack-edpm-ipam
      # - validate-network-edpm-deployment-openstack-edpm-ipam
      - { name: logging-edpm-deployment-openstack-edpm-ipam, nspace: openstack, status_str: "Completed", test_id: "RHOSO-12679"}
  tasks:
    - name: "Run pods completed tests"
      ansible.builtin.import_role:
        name: common

- name: "Verify the crds exist"
  hosts: controller
  gather_facts: no
  ignore_errors: true
  environment:
    KUBECONFIG: "{{ cifmw_openshift_kubeconfig }}"
    PATH: "{{ cifmw_path }}"
  vars:
    common_service_test_id: "RHOSO-12749"
    common_service_nspace: openstack
    common_service_list:
      - { name: nova-internal, nspace: openstack, test_id: "{{ common_service_test_id }}" }
      - { name: nova-metadata-internal, nspace: openstack, test_id: "{{ common_service_test_id }}" }
      - { name: nova-novncproxy-cell1-public, nspace: openstack, test_id: "{{ common_service_test_id }}" }
      - { name: nova-public, nspace: openstack, test_id: "{{ common_service_test_id }}" }
    #common_crd_test_id: "RHOSO-12670"
    common_crd_list:
      - { name: alertingrules.loki.grafana.com, test_id: "RHOSO-12670"}
      - { name: lokistacks.loki.grafana.com, test_id: "RHOSO-13787"}
      - { name: recordingrules.loki.grafana.com, test_id: "RHOSO-13788"}
      - { name: rulerconfigs.loki.grafana.com, test_id: "RHOSO-13789"}
  tasks:
    - name: "Run Services and CRD tests"
      ansible.builtin.import_role:
        name: common
